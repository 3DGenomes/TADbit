<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pytadbit.mapping.mapper &mdash; Tadbit 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/forkme_nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/black-on-white.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../_static/TADbit_icon.ico"/>
    <link rel="top" title="Tadbit 0.1 documentation" href="../../../index.html" />
    <link rel="up" title="pytadbit" href="../../pytadbit.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Tadbit 0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../pytadbit.html" accesskey="U">pytadbit</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pytadbit.mapping.mapper</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">10 nov. 2014</span>

<span class="sd">iterative mapping copied from hiclib</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pysam</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s">&#39;WARNING: PYSAM not found&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">gem</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s">&#39;WARNING: GEMTOOLS not found&#39;</span><span class="p">)</span>

<span class="n">N_WINDOWS</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">eq_reads</span><span class="p">(</span><span class="n">rd1</span><span class="p">,</span> <span class="n">rd2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare reads accounting for multicontacts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">rd1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">rd2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="get_intersection"><a class="viewcode-back" href="../../../reference/reference_mapping.html#pytadbit.mapping.mapper.get_intersection">[docs]</a><span class="k">def</span> <span class="nf">get_intersection</span><span class="p">(</span><span class="n">fname1</span><span class="p">,</span> <span class="n">fname2</span><span class="p">,</span> <span class="n">out_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merges the two files corresponding to each reads sides. Reads found in both</span>
<span class="sd">       files are merged and written in an output file.</span>

<span class="sd">    Dealing with multiple contacts:</span>
<span class="sd">       - a pairwise contact is created for each possible combnation of the</span>
<span class="sd">         multicontacts. The name of the read is extended by &#39;# 1/3&#39; in case</span>
<span class="sd">         the reported pairwise contact corresponds to the first of 3 possibles</span>
<span class="sd">       - it may happen that different contacts are mapped on a single RE fragment</span>
<span class="sd">         (if each are on different end), in which case:</span>
<span class="sd">          - if no other fragment from this read are mapped than, both are kept</span>
<span class="sd">          - otherwise, they are merged into one longer (as if they were mapped</span>
<span class="sd">            in the positive strand)</span>

<span class="sd">    :param fname1: path to a tab separated file generated by the function</span>
<span class="sd">       :func:`pytadbit.parsers.sam_parser.parse_sam`</span>
<span class="sd">    :param fname2: path to a tab separated file generated by the function</span>
<span class="sd">       :func:`pytadbit.parsers.sam_parser.parse_sam`</span>
<span class="sd">    :param out_path: path to an outfile. It will written in a similar format as</span>
<span class="sd">       the inputs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reads_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">reads1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname1</span><span class="p">)</span>
    <span class="n">line1</span> <span class="o">=</span> <span class="n">reads1</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">header1</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">while</span> <span class="n">line1</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line1</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;# CRM&#39;</span><span class="p">):</span>
            <span class="n">header1</span> <span class="o">+=</span> <span class="n">line1</span>
        <span class="n">line1</span> <span class="o">=</span> <span class="n">reads1</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">read1</span> <span class="o">=</span> <span class="n">line1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">reads2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname2</span><span class="p">)</span>
    <span class="n">line2</span> <span class="o">=</span> <span class="n">reads2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">header2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">while</span> <span class="n">line2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;# CRM&#39;</span><span class="p">):</span>
            <span class="n">header2</span> <span class="o">+=</span> <span class="n">line2</span>
        <span class="n">line2</span> <span class="o">=</span> <span class="n">reads2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">read2</span> <span class="o">=</span> <span class="n">line2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">header1</span> <span class="o">!=</span> <span class="n">header2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;seems to be mapped onover different chromosomes</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="c"># setup REGEX to split reads in a single line</span>
    <span class="c"># readex = recompile(&#39;((?:[^\t]+\t){6}[^\t]+)&#39;)</span>
    <span class="c"># writes header in output</span>
    <span class="n">reads_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header1</span><span class="p">)</span>
    <span class="c"># writes common reads</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eq_reads</span><span class="p">(</span><span class="n">read1</span><span class="p">,</span> <span class="n">read2</span><span class="p">):</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c"># case we have potential multicontacts</span>
                <span class="k">if</span> <span class="s">&#39;|||&#39;</span> <span class="ow">in</span> <span class="n">line1</span> <span class="ow">or</span> <span class="s">&#39;|||&#39;</span> <span class="ow">in</span> <span class="n">line2</span><span class="p">:</span>
                    <span class="n">elts</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">line1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;|||&#39;</span><span class="p">):</span>
                        <span class="n">nam</span><span class="p">,</span> <span class="n">crm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strd</span><span class="p">,</span> <span class="n">nts</span><span class="p">,</span> <span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
                        <span class="n">elts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">crm</span><span class="p">,</span> <span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">nam</span><span class="p">,</span> <span class="n">crm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strd</span><span class="p">,</span> <span class="n">nts</span><span class="p">,</span> <span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">line2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;|||&#39;</span><span class="p">):</span>
                        <span class="n">nam</span><span class="p">,</span> <span class="n">crm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strd</span><span class="p">,</span> <span class="n">nts</span><span class="p">,</span> <span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
                        <span class="n">elts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">crm</span><span class="p">,</span> <span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">nam</span><span class="p">,</span> <span class="n">crm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">strd</span><span class="p">,</span> <span class="n">nts</span><span class="p">,</span> <span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
                    <span class="c"># write contacts by pairs</span>
                    <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">elts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">]</span> <span class="o">=</span> <span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">elts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                                <span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">],</span>
                                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))[::</span><span class="nb">len</span><span class="p">(</span><span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">elts1</span> <span class="o">=</span> <span class="p">{</span><span class="n">elt</span><span class="p">:</span> <span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">][</span><span class="mi">0</span><span class="p">]}</span>
                            <span class="n">elts2</span> <span class="o">=</span> <span class="p">{</span><span class="n">elt</span><span class="p">:</span> <span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">][</span><span class="mi">1</span><span class="p">]}</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">map1</span><span class="p">,</span> <span class="n">map2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                                <span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">],</span>
                                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))[::</span><span class="nb">len</span><span class="p">(</span><span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">]</span> <span class="o">=</span> <span class="n">map1</span>
                            <span class="k">if</span> <span class="n">map1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;1&#39;</span><span class="p">:</span>
                                <span class="n">beg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">map1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">beg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">map1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">map1</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">map2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span><span class="p">:</span>
                                <span class="n">nts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">map2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">beg</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">nts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">map2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">map2</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">beg</span>
                            <span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
                                              <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">beg</span><span class="p">),</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nts</span><span class="p">)]</span> <span class="o">+</span>
                                              <span class="nb">list</span><span class="p">(</span><span class="n">elts</span><span class="p">[</span><span class="n">elt</span><span class="p">][</span><span class="mi">5</span><span class="p">:]))</span>
                    <span class="n">contacts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">contacts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">elts</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)):</span>
                            <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">reads_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                                <span class="s">&#39;#</span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">contacts</span> <span class="o">*</span> <span class="p">(</span><span class="n">contacts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span>
                                           <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r1</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="o">+</span> 
                                           <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r2</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">contacts</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">elts</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">elts</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span>
                                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">reads_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="o">+</span> 
                                       <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r2</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">elts1</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">elts2</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span>
                                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">reads_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="o">+</span> 
                                       <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r2</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">line1</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">line2</span><span class="o">.</span><span class="n">split</span><span class="p">()),</span>
                                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">reads_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="o">+</span>
                                   <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r2</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">line1</span> <span class="o">=</span> <span class="n">reads1</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="n">read1</span> <span class="o">=</span> <span class="n">line1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">line2</span> <span class="o">=</span> <span class="n">reads2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="n">read2</span> <span class="o">=</span> <span class="n">line2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c"># if first element of line1 is greater than the one of line2:</span>
            <span class="k">elif</span> <span class="n">locale</span><span class="o">.</span><span class="n">strcoll</span><span class="p">(</span><span class="n">read1</span><span class="p">,</span> <span class="n">read2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">line2</span> <span class="o">=</span> <span class="n">reads2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="n">read2</span> <span class="o">=</span> <span class="n">line2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line1</span> <span class="o">=</span> <span class="n">reads1</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="n">read1</span> <span class="o">=</span> <span class="n">line1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="n">reads1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">reads2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">reads_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;Found </span><span class="si">%d</span><span class="s"> pair of reads mapping uniquely&#39;</span> <span class="o">%</span> <span class="n">count</span>
</div>
<span class="k">def</span> <span class="nf">trimming</span><span class="p">(</span><span class="n">raw_seq_len</span><span class="p">,</span> <span class="n">seq_start</span><span class="p">,</span> <span class="n">min_seq_len</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">seq_start</span><span class="p">,</span> <span class="n">raw_seq_len</span> <span class="o">-</span> <span class="n">seq_start</span> <span class="o">-</span> <span class="n">min_seq_len</span>

<div class="viewcode-block" id="iterative_mapping"><a class="viewcode-back" href="../../../reference/reference_mapping.html#pytadbit.mapping.mapper.iterative_mapping">[docs]</a><span class="k">def</span> <span class="nf">iterative_mapping</span><span class="p">(</span><span class="n">gem_index_path</span><span class="p">,</span> <span class="n">fastq_path</span><span class="p">,</span> <span class="n">out_sam_path</span><span class="p">,</span>
                      <span class="n">range_start</span><span class="p">,</span> <span class="n">range_stop</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map iteratively a given FASTQ file to a reference genome.</span>
<span class="sd">    </span>
<span class="sd">    :param gem_index_path: path to index file created from a reference genome</span>
<span class="sd">       using gem-index tool</span>
<span class="sd">    :param fastq_path: PATH to fastq file, either compressed or not.</span>
<span class="sd">    :param out_sam_path: path to a directory where to store mapped reads in SAM/</span>
<span class="sd">       BAM format (see option output_is_bam).</span>
<span class="sd">    :param range_start: list of integers representing the start position of each</span>
<span class="sd">       read fragment to be mapped (starting at 1 includes the first nucleotide</span>
<span class="sd">       of the read).</span>
<span class="sd">    :param range_stop: list of integers representing the end position of each</span>
<span class="sd">       read fragment to be mapped.</span>
<span class="sd">    :param True single_end: when FASTQ contains paired-ends flags</span>
<span class="sd">    :param 4 nthreads: number of threads to use for mapping (number of CPUs)</span>
<span class="sd">    :param 0.04 max_edit_distance: The maximum number of edit operations allowed</span>
<span class="sd">       while verifying candidate matches by dynamic programming.</span>
<span class="sd">    :param 0.04 mismatches: The maximum number of nucleotide substitutions</span>
<span class="sd">       allowed while mapping each k-mer. It is always guaranteed that, however</span>
<span class="sd">       other options are chosen, all the matches up to the specified number of</span>
<span class="sd">       substitutions will be found by the program.</span>
<span class="sd">    :param -1 max_reads_per_chunk: maximum number of reads to process at a time.</span>
<span class="sd">       If -1, all reads will be processed in one run (more RAM memory needed).</span>
<span class="sd">    :param False output_is_bam: Use binary (compressed) form of generated</span>
<span class="sd">       out-files with mapped reads (recommended to save disk space).</span>
<span class="sd">    :param /tmp temp_dir: important to change. Intermediate FASTQ files will be</span>
<span class="sd">       written there.</span>

<span class="sd">    :returns: a list of paths to generated outfiles. To be passed to </span>
<span class="sd">       :func:`pytadbit.parsers.sam_parser.parse_sam`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gem_index_path</span>      <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">gem_index_path</span><span class="p">))</span>
    <span class="n">fastq_path</span>          <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fastq_path</span><span class="p">))</span>
    <span class="n">out_sam_path</span>        <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">out_sam_path</span><span class="p">))</span>
    <span class="n">single_end</span>          <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;single_end&#39;</span>          <span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">max_edit_distance</span>   <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;max_edit_distance&#39;</span>   <span class="p">,</span> <span class="mf">0.04</span><span class="p">)</span>
    <span class="n">mismatches</span>          <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;mismatches&#39;</span>          <span class="p">,</span> <span class="mf">0.04</span><span class="p">)</span>
    <span class="n">nthreads</span>            <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;nthreads&#39;</span>            <span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">max_reads_per_chunk</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;max_reads_per_chunk&#39;</span> <span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out_files</span>           <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;out_files&#39;</span>           <span class="p">,</span> <span class="p">[])</span>
    <span class="n">output_is_bam</span>       <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;output_is_bam&#39;</span>       <span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;temp_dir&#39;</span><span class="p">,</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">())))</span>

    <span class="c"># check kwargs</span>
    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kw</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;single_end&#39;</span><span class="p">,</span> <span class="s">&#39;nthreads&#39;</span><span class="p">,</span> <span class="s">&#39;max_edit_distance&#39;</span><span class="p">,</span>
                      <span class="s">&#39;mismatches&#39;</span><span class="p">,</span> <span class="s">&#39;max_reads_per_chunk&#39;</span><span class="p">,</span>
                      <span class="s">&#39;out_files&#39;</span><span class="p">,</span> <span class="s">&#39;output_is_bam&#39;</span><span class="p">,</span> <span class="s">&#39;temp_dir&#39;</span><span class="p">]:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s">&#39;WARNING: </span><span class="si">%s</span><span class="s"> not is usual keywords, misspelled?&#39;</span> <span class="o">%</span> <span class="n">kw</span><span class="p">)</span>
    
    <span class="c"># check windows:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">range_start</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">range_stop</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">range_start</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">range_stop</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: range_start and range_stop should be lists&#39;</span><span class="p">)</span>
        <span class="n">range_start</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">range_start</span><span class="p">)</span>
        <span class="n">range_stop</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">range_stop</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">range_start</span><span class="p">)</span> <span class="ow">or</span>
        <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">range_stop</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">range_start</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">range_start</span><span class="p">)</span>
            <span class="n">range_stop</span>  <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">range_stop</span><span class="p">)</span>            
            <span class="n">warn</span><span class="p">(</span><span class="s">&#39;WARNING: range_start and range_stop converted to integers&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: range_start and range_stop should contain&#39;</span> <span class="o">+</span>
                            <span class="s">&#39; integers only&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">range_start</span><span class="p">,</span> <span class="n">range_stop</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">range_start</span><span class="p">)</span> <span class="ow">or</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">range_start</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">range_stop</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: range_start and range_stop should have the &#39;</span> <span class="o">+</span>
                        <span class="s">&#39;same sizes and windows should be uniques.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">range_start</span><span class="p">,</span> <span class="n">range_stop</span><span class="p">)]):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: start positions should always be lower than &#39;</span> <span class="o">+</span>
                        <span class="s">&#39;stop positions.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">range_start</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: start positions should be strictly positive.&#39;</span><span class="p">)</span>

    <span class="c"># create directories</span>
    <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="p">[</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_sam_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">strerror</span> <span class="o">!=</span> <span class="s">&#39;File exists&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span>

    <span class="c">#get the length of a read</span>
    <span class="k">if</span> <span class="n">fastq_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.gz&#39;</span><span class="p">):</span>
        <span class="n">fastqh</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fastq_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fastqh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fastq_path</span><span class="p">)</span>
    <span class="c"># get the length from the length of the second line, which is the sequence</span>
    <span class="c"># can not use the &quot;length&quot; keyword, as it is not always present</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">fastqh</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">raw_seq_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fastqh</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">fastqh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&#39;ERROR: problem reading </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fastq_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span>  <span class="n">N_WINDOWS</span><span class="p">:</span>
        <span class="n">N_WINDOWS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">range_start</span><span class="p">)</span>
    <span class="c"># Split input files if required and apply iterative mapping to each</span>
    <span class="c"># segment separately.</span>
    <span class="k">if</span> <span class="n">max_reads_per_chunk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;max_reads_per_chunk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">print</span> <span class="s">&#39;Split input file </span><span class="si">%s</span><span class="s"> into chunks&#39;</span> <span class="o">%</span> <span class="n">fastq_path</span>
        <span class="n">chunked_files</span> <span class="o">=</span> <span class="n">_chunk_file</span><span class="p">(</span>
            <span class="n">fastq_path</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fastq_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">max_reads_per_chunk</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s"> chunks obtained&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunked_files</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fastq_chunk_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunked_files</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">N_WINDOWS</span>
            <span class="n">N_WINDOWS</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">print</span> <span class="s">&#39;Run iterative_mapping recursively on </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fastq_chunk_path</span>
            <span class="n">out_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">iterative_mapping</span><span class="p">(</span>
                <span class="n">gem_index_path</span><span class="p">,</span> <span class="n">fastq_chunk_path</span><span class="p">,</span>
                <span class="n">out_sam_path</span> <span class="o">+</span> <span class="s">&#39;.</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">range_start</span><span class="p">[:],</span> <span class="n">range_stop</span><span class="p">[:],</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fastq_chunk_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunked_files</span><span class="p">):</span>
            <span class="c"># Delete chunks only if the file was really chunked.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunked_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;Remove the chunks: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunked_files</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fastq_chunk_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_files</span>

    <span class="c"># end position according to sequence in the file</span>
    <span class="c"># removes 1 in order to start at 1 instead of 0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">seq_end</span> <span class="o">=</span> <span class="n">range_stop</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">seq_beg</span> <span class="o">=</span> <span class="n">range_start</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">out_files</span>

    <span class="c"># define what we trim</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="n">seq_end</span> <span class="o">-</span> <span class="n">seq_beg</span>
    <span class="n">trim_5</span><span class="p">,</span> <span class="n">trim_3</span> <span class="o">=</span> <span class="n">trimming</span><span class="p">(</span><span class="n">raw_seq_len</span><span class="p">,</span> <span class="n">seq_beg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c"># output</span>
    <span class="n">local_out_sam</span> <span class="o">=</span> <span class="n">out_sam_path</span> <span class="o">+</span> <span class="s">&#39;.</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">-</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">N_WINDOWS</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">range_stop</span><span class="p">),</span> <span class="n">seq_beg</span><span class="p">,</span> <span class="n">seq_end</span><span class="p">)</span>
    <span class="n">out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_out_sam</span><span class="p">)</span>
    <span class="c"># input</span>
    <span class="n">inputf</span> <span class="o">=</span> <span class="n">gem</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fastq_path</span><span class="p">)</span>

    <span class="c"># trimming</span>
    <span class="n">trimmed</span> <span class="o">=</span> <span class="n">gem</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">run_filter</span><span class="p">(</span>
        <span class="n">inputf</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;--hard-trim&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trim_5</span><span class="p">,</span> <span class="n">trim_3</span><span class="p">)],</span>
        <span class="n">threads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="ow">not</span> <span class="n">single_end</span><span class="p">)</span>

    <span class="c"># mapping</span>
    <span class="n">mapped</span> <span class="o">=</span> <span class="n">gem</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">trimmed</span><span class="p">,</span> <span class="n">gem_index_path</span><span class="p">,</span> <span class="n">min_decoded_strata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">max_decoded_matches</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">unique_mapping</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">max_edit_distance</span><span class="o">=</span><span class="n">max_edit_distance</span><span class="p">,</span>
                        <span class="n">mismatches</span><span class="o">=</span><span class="n">mismatches</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="n">temp_dir</span> <span class="o">+</span> <span class="s">&#39;/test.map&#39;</span><span class="p">,</span>
                        <span class="n">threads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">)</span>

    <span class="c"># convert to sam/bam</span>
    <span class="k">if</span> <span class="n">output_is_bam</span><span class="p">:</span>
        <span class="n">sam</span> <span class="o">=</span> <span class="n">gem</span><span class="o">.</span><span class="n">gem2sam</span><span class="p">(</span><span class="n">mapped</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">gem_index_path</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">,</span>
                          <span class="n">single_end</span><span class="o">=</span><span class="n">single_end</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">gem</span><span class="o">.</span><span class="n">sam2bam</span><span class="p">(</span><span class="n">sam</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">local_out_sam</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sam</span> <span class="o">=</span> <span class="n">gem</span><span class="o">.</span><span class="n">gem2sam</span><span class="p">(</span><span class="n">mapped</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">gem_index_path</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">local_out_sam</span><span class="p">,</span>
                          <span class="n">threads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">,</span> <span class="n">single_end</span><span class="o">=</span><span class="n">single_end</span><span class="p">)</span>

    <span class="c"># Recursively go to the next iteration.</span>
    <span class="n">unmapped_fastq_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fastq_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">unmapped_fastq_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">unmapped_fastq_path</span> <span class="o">=</span> <span class="n">unmapped_fastq_path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">unmapped_fastq_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">temp_dir</span><span class="p">,</span> <span class="n">unmapped_fastq_path</span> <span class="o">+</span> <span class="s">&#39;.</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">-</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">N_WINDOWS</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">range_stop</span><span class="p">),</span> <span class="n">seq_beg</span><span class="p">,</span> <span class="n">seq_end</span><span class="p">))</span>
    <span class="n">_filter_unmapped_fastq</span><span class="p">(</span><span class="n">fastq_path</span><span class="p">,</span> <span class="n">local_out_sam</span><span class="p">,</span> <span class="n">unmapped_fastq_path</span><span class="p">)</span>

    <span class="n">out_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">iterative_mapping</span><span class="p">(</span><span class="n">gem_index_path</span><span class="p">,</span> <span class="n">unmapped_fastq_path</span><span class="p">,</span>
                                       <span class="n">out_sam_path</span><span class="p">,</span>
                                       <span class="n">range_start</span><span class="p">,</span> <span class="n">range_stop</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">unmapped_fastq_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_files</span>
</div>
<span class="k">def</span> <span class="nf">_line_count</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Count the number of lines in a file. The function was posted by</span>
<span class="sd">    Mikola Kharechko on Stackoverflow.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">_gzopen</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">buf_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
    <span class="n">read_f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span>  <span class="c"># loop optimization</span>

    <span class="n">buf</span> <span class="o">=</span> <span class="n">read_f</span><span class="p">(</span><span class="n">buf_size</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">buf</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">+=</span> <span class="n">buf</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">read_f</span><span class="p">(</span><span class="n">buf_size</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lines</span>

<span class="k">def</span> <span class="nf">_chunk_file</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">out_basename</span><span class="p">,</span> <span class="n">max_num_lines</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Slice lines from a large file.</span>
<span class="sd">    The line numbering is as in Python slicing notation.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">num_lines</span> <span class="o">=</span> <span class="n">_line_count</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_lines</span> <span class="o">&lt;=</span> <span class="n">max_num_lines</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">in_path</span><span class="p">,</span> <span class="p">]</span>

    <span class="n">out_paths</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_gzopen</span><span class="p">(</span><span class="n">in_path</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">max_num_lines</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">out_basename</span> <span class="o">+</span> <span class="s">&#39;.</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="n">max_num_lines</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">out_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out_paths</span>

<span class="k">def</span> <span class="nf">_filter_fastq</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">in_fastq</span><span class="p">,</span> <span class="n">out_fastq</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Filter FASTQ sequences by their IDs.</span>

<span class="sd">    Read entries from **in_fastq** and store in **out_fastq** only those</span>
<span class="sd">    the whose ID are in **ids**.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_fastq</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">in_file</span> <span class="o">=</span> <span class="n">_gzopen</span><span class="p">(</span><span class="n">in_fastq</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">in_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&#39;{0} does not comply with the FASTQ standards.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">in_fastq</span><span class="p">))</span>

        <span class="n">fastq_entry</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">,</span> <span class="n">in_file</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span>
                       <span class="n">in_file</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="n">in_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()]</span>
        <span class="n">read_id</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">read_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/1&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">read_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/2&#39;</span><span class="p">):</span>
            <span class="n">read_id</span> <span class="o">=</span> <span class="n">read_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">read_id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">fastq_entry</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_filter_unmapped_fastq</span><span class="p">(</span><span class="n">in_fastq</span><span class="p">,</span> <span class="n">in_sam</span><span class="p">,</span> <span class="n">nonunique_fastq</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Read raw sequences from **in_fastq** and alignments from</span>
<span class="sd">    **in_sam** and save the non-uniquely aligned and unmapped sequences</span>
<span class="sd">    to **unique_sam**.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">samfile</span> <span class="o">=</span> <span class="n">pysam</span><span class="o">.</span><span class="n">Samfile</span><span class="p">(</span><span class="n">in_sam</span><span class="p">)</span>

    <span class="n">nonunique_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">samfile</span><span class="p">:</span>
        <span class="n">tags_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">read</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
        <span class="n">read_id</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">qname</span>
        <span class="c"># If exists, the option &#39;XS&#39; contains the score of the second</span>
        <span class="c"># best alignment. Therefore, its presence means non-unique alignment.</span>
        <span class="k">if</span> <span class="s">&#39;XS&#39;</span> <span class="ow">in</span> <span class="n">tags_dict</span> <span class="ow">or</span> <span class="n">read</span><span class="o">.</span><span class="n">is_unmapped</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="s">&#39;NH&#39;</span> <span class="ow">in</span> <span class="n">tags_dict</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">tags_dict</span><span class="p">[</span><span class="s">&#39;NH&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">nonunique_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">read_id</span><span class="p">)</span>
            
        <span class="c"># UNMAPPED reads should be included 5% chance to be mapped</span>
        <span class="c"># with larger fragments, so do not do this:</span>
        <span class="c"># if &#39;XS&#39; in tags_dict or (</span>
        <span class="c">#     &#39;NH&#39; in tags_dict and int(tags_dict[&#39;NH&#39;]) &gt; 1):</span>
        <span class="c">#     nonunique_ids.add(read_id)</span>

    <span class="n">_filter_fastq</span><span class="p">(</span><span class="n">nonunique_ids</span><span class="p">,</span> <span class="n">in_fastq</span><span class="p">,</span> <span class="n">nonunique_fastq</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_gzopen</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.gz&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/TADbit_logo_little.png" alt="Logo"/>
            </a></p>
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installing TADbit on GNU/Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../biblio.html">Bibliography</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Tadbit 0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../pytadbit.html" >pytadbit</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Last updated on Aug 12, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div><style>div.related ul {padding-right:150px;}</style>
        <a href="https://github.com/3DGenomes/tadbit" target="_blank"><img
            style="position: absolute; top: 0; right: 0; border: 0;"
            src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
  </body>
</html>