BootStrap: docker
From: debian:bullseye-slim

%help
  Minimal TADbit container.

%environment
  LANG=C.UTF-8
  LC_ALL=C.UTF-8
  PATH="/usr/local/anaconda/envs/env/bin:$PATH"
  export PATH LANG LC_ALL

%post
  # Basic environment setup and dependencies
  apt-get update -q && \
  apt-get install -q -y --no-install-recommends \
      dirmngr \
      apt-transport-https \
      ca-certificates \
      software-properties-common \
      gnupg2 \
      wget \
      bzip2 \
      unzip \
      build-essential \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/*

  # Install Miniconda
  wget --quiet --no-check-certificate "https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh" \
      -O /root/miniconda.sh && \
  /bin/bash /root/miniconda.sh -b -p /usr/local/anaconda && \
  rm /root/miniconda.sh

  # Initialize Conda and update it
  /usr/local/anaconda/bin/conda init
  /usr/local/anaconda/bin/conda config --set always_yes yes --set changeps1 no
  /usr/local/anaconda/bin/conda update -q conda

  # Add Conda channels
  /usr/local/anaconda/bin/conda config --add channels conda-forge
  /usr/local/anaconda/bin/conda config --add channels bioconda
  /usr/local/anaconda/bin/conda config --add channels salilab

  # Create and activate a new environment
  /usr/local/anaconda/bin/conda create -n env python=3.9
  echo "source /usr/local/anaconda/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT
  echo "conda activate env" >> $SINGULARITY_ENVIRONMENT

  # Now install your packages
  source /usr/local/anaconda/etc/profile.d/conda.sh && \
  conda activate env && \
  conda install -y -q imp scipy numpy matplotlib mcl samtools pysam ucsc-bigWigToBedGraph ucsc-wigtobigwig gem3-mapper hisat2

  # Clean up Conda
  conda clean -y --all && rm -rf /opt/conda/pkgs/*

  # Clean up after apt-get
  apt-get remove -y --purge unzip build-essential && \
  apt-get autoremove -y && \
  apt-get autoclean -y && \
  rm -rf /var/lib/apt/lists/*

%runscript
  echo "Welcome to the TADbit Singularity container."
  exec /bin/bash "$@"

