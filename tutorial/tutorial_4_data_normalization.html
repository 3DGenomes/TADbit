<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Hi-C data processing &mdash; Tadbit 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/forkme_nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/black-on-white.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../_static/TADbit_icon.ico"/>
    <link rel="top" title="Tadbit 0.1 documentation" href="../index.html" />
    <link rel="up" title="Tutorials" href="../tutorial.html" />
    <link rel="next" title="Parameter optimization for IMP." href="tutorial_5_parameter_optimization.html" />
    <link rel="prev" title="TAD clustering" href="tutorial_3_clustering.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="tutorial_5_parameter_optimization.html" title="Parameter optimization for IMP."
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="tutorial_3_clustering.html" title="TAD clustering"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Tadbit 0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../tutorial.html" accesskey="U">Tutorials</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="hi-c-data-processing">
<h1>Hi-C data processing<a class="headerlink" href="#hi-c-data-processing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="data-filtering">
<h2>Data filtering<a class="headerlink" href="#data-filtering" title="Permalink to this headline">¶</a></h2>
<div class="section" id="remove-outliers">
<h3>Remove outliers<a class="headerlink" href="#remove-outliers" title="Permalink to this headline">¶</a></h3>
<p>To model chromatin structure, we need to ensure that our data is clean
enough. The first step is thus to draw the distribution of the sum of
interactions per raw/columns in the Hi-C matrix. According to this
distribution, we may remove some columns if they present a suspiciously
low count of interaction.</p>
<p>Here an example, where &#8220;exp&#8221; is an preloaded Experiment corresponding to
human&#8217;s 19th chromosome:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pytadbit</span> <span class="kn">import</span> <span class="n">Chromosome</span>

<span class="n">my_chrom</span> <span class="o">=</span> <span class="n">Chromosome</span><span class="p">(</span><span class="s">&#39;19&#39;</span><span class="p">)</span>
<span class="n">my_chrom</span><span class="o">.</span><span class="n">add_experiment</span><span class="p">(</span><span class="s">&#39;gm&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                        <span class="n">hic_data</span><span class="o">=</span><span class="s">&#39;../../scripts/sample_data/HIC_gm06690_chr19_chr19_100000_obs.txt&#39;</span><span class="p">)</span>

<span class="n">exp</span> <span class="o">=</span> <span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">zeroes</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">filter_columns</span><span class="p">(</span><span class="n">draw_hist</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
/usr/local/lib/python2.7/dist-packages/pytadbit/parsers/hic_parser.py:93: UserWarning: WARNING: non integer values
  warn('WARNING: non integer values')
/usr/lib/python2.7/dist-packages/numpy/core/numeric.py:460: ComplexWarning: Casting complex values to real discards the imaginary part
  return array(a, dtype, copy=False, order=order)
</pre>
<img alt="../_images/tutorial_4_data_normalization_4_1.png" src="../_images/tutorial_4_data_normalization_4_1.png" />
<pre class="ansi-block literal-block">
/usr/local/lib/python2.7/dist-packages/pytadbit/utils/hic_filtering.py:132: ComplexWarning: Casting complex values to real discards the imaginary part
  round(root, 3), ' '.join(

WARNING: removing columns having less than 67.485 counts:
   246   247   248   249   250   251   252   253   254   255   256   257   258   259   260   261   262   263   264   265
   266   267   268   269   270   271   272   273   274   275   276   277   278   279   280   281   282   283   284   285
   286   287   288   289   290   291   292   293   294   295   296   297   298   299   300   301   302   303   304   305
   306   307   308   309   310   311   312   313   314   315   316   317   318   319   320   321   322   323   324   639
</pre>
<p><em>Note that the columns cited in the warning correspond to the columns on
the left of the dot vertical red line</em></p>
<p>Than, according to the fit represented above, we would discard all
columns in the Hi-C raw data having cumulative count of interaction
below the dashed red line in the graph above (~67). This columns will be
removed from the modeling, and their associated particles will have no
experimental data.</p>
<p><em>This step is done automatically within tadbit each time an experiment
is loaded. In order to ensure that we do remove outlier columns, tadbit
checks if this root corresponds to a</em> <strong>concave down</strong> <em>region and if it
stands</em> <strong>between zero and the median</strong> *of the overall distribution.
The result of these &#8220;bad&#8221; columns is stored in the variable
Experiment._zeros, that represents the columns to be skipped in the
consecutive steps.*</p>
<p>*Also it is not recommended to do it, the column filtering can be
skipped, using the <code class="docutils literal"><span class="pre">filter_columns=False</span></code> parameter when loading or
creating a :class:<code class="docutils literal"><span class="pre">pytadbit.experiment.Experiment</span></code></p>
</div>
<div class="section" id="remove-row-columns-where-diagonal-is-null">
<h3>Remove row/columns where diagonal is null<a class="headerlink" href="#remove-row-columns-where-diagonal-is-null" title="Permalink to this headline">¶</a></h3>
<p>In case TADbit find a null value right in the diagonal of the Hi-C data
matrix (where highest values are expected), TADbit assumes that this
observation is artefactual and removes the whole row and column passing
through this bin.</p>
</div>
<div class="section" id="dealing-with-nans">
<h3>Dealing with NaNs<a class="headerlink" href="#dealing-with-nans" title="Permalink to this headline">¶</a></h3>
<p>Any row or column that contains a <em>NaN</em> value will be removed from
further steps.</p>
</div>
</div>
<div class="section" id="data-normalization">
<h2>Data normalization<a class="headerlink" href="#data-normalization" title="Permalink to this headline">¶</a></h2>
<p>Hi-C data stored in <a class="reference internal" href="../reference/reference_experiment.html#pytadbit.experiment.Experiment" title="pytadbit.experiment.Experiment"><code class="xref py py-class docutils literal"><span class="pre">pytadbit.experiment.Experiment</span></code></a> might be normalized in order to be used by IMP.
This normalization is achieve in two steps, first we generate weight for each pair of interactions, depending on the interaction count in the corresponding row/column, second we calculate the <a class="reference external" href="http://en.wikipedia.org/wiki/Standard_score#Calculation_from_raw_score">z-score</a> of each of these interaction pairs.
Calculation of weights
~~~~~~~~~~~~~~~~~~~~~~
Weights are calculated according to this formula (see <a class="reference internal" href="../reference/reference_experiment.html#pytadbit.experiment.Experiment.normalize_hic" title="pytadbit.experiment.Experiment.normalize_hic"><code class="xref py py-func docutils literal"><span class="pre">pytadbit.experiment.Experiment.normalize_hic()</span></code></a>):</p>
<div class="math">
\[weight(I, J) = \frac{\sum^N_{i=0}{\sum^N_{j=0}{(matrix(i, j))}}}{\sum^N_{i=0}{(matrix(i, J))} \times \sum^N_{j=0}{(matrix(I, j))}}\]</div>
<p>&#8220;matrix&#8221;, being our row data (count of interactions), N the number of rows/columns.</p>
<p>The result is stored in a new matrix, called weight. The values that will be used in the next step are the multiplication of this weights per the raw data.</p>
<p>There is one extra step of the normalization that consists in making the normalized values comparable between experiments. This step is control by the parameter <cite>factor</cite> and consists in asking to the function to normalize in order that the overall mean value of a cell would be equal to the value of <cite>factor</cite>. By default factor is set to 1, thus the mean value of a cell in a normalized matrix would be 1, and the summ of the normalized Hi-C count of a matrix of 100x100 would be equal to 10000. When 2 experiments are summed the resulting experiment would have a factor equal to the sum of the factors of the summed experiments, and in the same way, when changes in the resoltuion of an experiment (through <a class="reference internal" href="../reference/reference_experiment.html#pytadbit.experiment.Experiment.set_resolution" title="pytadbit.experiment.Experiment.set_resolution"><code class="xref py py-func docutils literal"><span class="pre">pytadbit.experiment.Experiment.set_resolution()</span></code></a>) will also change the factor according to the change of the resolution.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Filtered rows/columns are not taken into account for normalization</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When modelling a portion of a chromosome values used are taken from the normalization of the whole chromosome, <strong>no local normalization is done</strong>.</p>
</div>
<div class="section" id="calculation-of-the-z-score">
<h3>Calculation of the z-score<a class="headerlink" href="#calculation-of-the-z-score" title="Permalink to this headline">¶</a></h3>
<p>Z-scores are computed according to classical formula (<span class="math">\(\frac{x-\mu}{\sigma}\)</span>), over the decimal logarithm values of the normalized data (see above). Ending in this formula:</p>
<div class="math">
\[zscore(I, J) = \frac{log_{10}(weight(I, J) \times matrix(I, J)) - mean(log_{10}(weight \times matrix))}{stddev(log_{10}(weight \times matrix))}\]</div>
<p><strong>Important: values on the diagonal are not taken into account for this calculus.</strong>
Dealing with zeros
^^^^^^^^^^^^^^^^^^
A zero in an Hi-C interaction matrix, means that the given two fragments of DNA were never found close enough to be crosslinked together. However such values are also highly suspicious to be artifacts.</p>
<p>Right now we assume that <span class="math">\(log_{10}(0) = 0\)</span>, in the calculation of the mean and stddev, and equal to -1 in the calculation of the z-score itself.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/TADbit_logo_little.png" alt="Logo"/>
            </a></p>
<h3><a href="../index.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installing TADbit on GNU/Linux</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../tutorial.html#from-fastq-files-to-interaction-matrices">From FASTQ files to interaction matrices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial.html#identification-and-analysis-of-tads">Identification and Analysis of TADs</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../tutorial.html#three-dimentional-modelling">Three-dimentional modelling</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="">Hi-C data processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_5_parameter_optimization.html">Parameter optimization for IMP.</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_6_modelling_and_analysis.html">Three-dimensional modeling of chromatine structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_7_single_model_analysis.html">Structural analysis of a chromatin model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../biblio.html">Bibliography</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="tutorial_3_clustering.html"
                        title="previous chapter">TAD clustering</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="tutorial_5_parameter_optimization.html"
                        title="next chapter">Parameter optimization for IMP.</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="tutorial_5_parameter_optimization.html" title="Parameter optimization for IMP."
             >next</a> |</li>
        <li class="right" >
          <a href="tutorial_3_clustering.html" title="TAD clustering"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Tadbit 0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../tutorial.html" >Tutorials</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Last updated on May 09, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div><style>div.related ul {padding-right:150px;}</style>
        <a href="https://github.com/3DGenomes/tadbit" target="_blank"><img
            style="position: absolute; top: 0; right: 0; border: 0;"
            src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
  </body>
</html>