<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Three-dimensional modeling of chromatine structure &mdash; Tadbit 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/forkme_nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/black-on-white.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../_static/TADbit_icon.ico"/>
    <link rel="top" title="Tadbit 0.1 documentation" href="../index.html" />
    <link rel="up" title="Tutorials" href="../tutorial.html" />
    <link rel="next" title="Structural analysis of a chromatin model" href="tutorial_7_single_model_analysis.html" />
    <link rel="prev" title="Parameter optimization for IMP." href="tutorial_5_parameter_optimization.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="tutorial_7_single_model_analysis.html" title="Structural analysis of a chromatin model"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="tutorial_5_parameter_optimization.html" title="Parameter optimization for IMP."
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Tadbit 0.1 documentation</a> &raquo;</li>
          <li><a href="../tutorial.html" accesskey="U">Tutorials</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="three-dimensional-modeling-of-chromatine-structure">
<h1>Three-dimensional modeling of chromatine structure<a class="headerlink" href="#three-dimensional-modeling-of-chromatine-structure" title="Permalink to this headline">¶</a></h1>
<p>Recover data from previous tutorial by loading the previously saved chromosome.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Libraries</span>
<span class="kn">from</span> <span class="nn">pytadbit</span> <span class="kn">import</span> <span class="n">load_chromosome</span> <span class="c"># load chromosome</span>
<span class="kn">from</span> <span class="nn">pytadbit.imp.CONFIG</span> <span class="kn">import</span> <span class="n">CONFIG</span> <span class="c"># Pre-defined parameters for modeling</span>
<span class="kn">from</span> <span class="nn">pytadbit.imp.structuralmodels</span> <span class="kn">import</span> <span class="n">load_structuralmodels</span> <span class="c"># library for modeling.</span>

<span class="c"># Load the chromosome</span>
<span class="n">my_chrom</span> <span class="o">=</span> <span class="n">load_chromosome</span><span class="p">(</span><span class="s">&#39;some_path.tdb&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, load Hi-C data for each experiment (Hi-C data is not saved inside chromosome objects because of their size):</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Loop over experiments in chromosome and load Hi-C data.</span>
<span class="n">res</span> <span class="o">=</span> <span class="mi">100000</span>

<span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">exp</span><span class="o">.</span><span class="n">load_hic_data</span><span class="p">(</span><span class="s">&#39;../../scripts/sample_data/HIC_{0}_{1}_{1}_{2}_obs.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                          <span class="n">exp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">my_chrom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;file not found for experiment: &#39;</span> <span class="o">+</span> <span class="n">exp</span><span class="o">.</span><span class="n">name</span>
        <span class="k">continue</span>

<span class="c"># Load Hi-C of the individual experiments and put it into the sum experiment BR+TR1+TR2</span>
<span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="s">&#39;k562+gm06690&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load_hic_data</span><span class="p">(</span>
              <span class="p">(</span><span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="s">&#39;k562&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="s">&#39;gm06690&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">hic_data</span><span class="p">,</span>
              <span class="s">&#39;k562+gm06690&#39;</span><span class="p">)</span>
<span class="n">exp</span> <span class="o">=</span> <span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="s">&#39;gm06690&#39;</span><span class="p">]</span>

<span class="k">print</span> <span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
/usr/local/lib/python2.7/dist-packages/pytadbit/parsers/hic_parser.py:93: UserWarning: WARNING: non integer values
  warn('WARNING: non integer values')

WARNING: removing columns having less than 24.165 counts: (detected threshold)
     8     9    10    12   245   246   247   248   249   250
   251   252   253   254   255   256   257   258   259   260
   261   262   263   264   265   266   267   268   269   270
   271   272   273   274   275   276   277   278   279   280
   281   282   283   284   285   286   287   288   289   290
   291   292   293   294   295   296   297   298   299   300
   301   302   303   304   305   306   307   308   309   310
   311   312   313   314   315   316   317   318   319   320
   321   322   323   324   639
/usr/local/lib/python2.7/dist-packages/pytadbit/utils/hic_filtering.py:209: ComplexWarning: Casting complex values to real discards the imaginary part
  round(root, 3), ' '.join(

WARNING: removing columns having less than 67.485 counts: (detected threshold)
   246   247   248   249   250   251   252   253   254   255
   256   257   258   259   260   261   262   263   264   265
   266   267   268   269   270   271   272   273   274   275
   276   277   278   279   280   281   282   283   284   285
   286   287   288   289   290   291   292   293   294   295
   296   297   298   299   300   301   302   303   304   305
   306   307   308   309   310   311   312   313   314   315
   316   317   318   319   320   321   322   323   324   639


WARNING: removing columns having less than 73.545 counts: (detected threshold)
   246   247   248   249   250   251   252   253   254   255
   256   257   258   259   260   261   262   263   264   265
   266   267   268   269   270   271   272   273   274   275
   276   277   278   279   280   281   282   283   284   285
   286   287   288   289   290   291   292   293   294   295
   296   297   298   299   300   301   302   303   304   305
   306   307   308   309   310   311   312   313   314   315
   316   317   318   319   320   321   322   323   324   639

/usr/local/lib/python2.7/dist-packages/pytadbit/experiment.py:215: UserWarning: WARNING: experiments should be normalized before being summed

  'summed\n')

WARNING: removing columns having less than 73.545 counts: (detected threshold)
   246   247   248   249   250   251   252   253   254   255
   256   257   258   259   260   261   262   263   264   265
   266   267   268   269   270   271   272   273   274   275
   276   277   278   279   280   281   282   283   284   285
   286   287   288   289   290   291   292   293   294   295
   296   297   298   299   300   301   302   303   304   305
   306   307   308   309   310   311   312   313   314   315
   316   317   318   319   320   321   322   323   324   639
</pre>
<pre class="ansi-block literal-block">
file not found for experiment: k562+gm06690
file not found for experiment: batch_gm06690_k562
[Experiment k562 (resolution: 100Kb, TADs: 37, Hi-C rows: 639, normalized: None), Experiment gm06690 (resolution: 100Kb, TADs: 34, Hi-C rows: 639, normalized: None), Experiment k562+gm06690 (resolution: 100Kb, TADs: None, Hi-C rows: 639, normalized: None), Experiment batch_gm06690_k562 (resolution: 100Kb, TADs: 35, Hi-C rows: 639, normalized: None)]
</pre>
<div class="section" id="model-the-3d-structure-of-a-selected-tad">
<h2>Model the 3D structure of a selected TAD<a class="headerlink" href="#model-the-3d-structure-of-a-selected-tad" title="Permalink to this headline">¶</a></h2>
<p>TADbit uses the Integrative Modeling Platform (IMP, <a class="reference external" href="http://www.integrativemodeling.org">http://www.integrativemodeling.org</a>) for modeling the 3D structure of genomes and genomic domains. Here we aim at modeling the 3D structure of the selected TAD in the first tutorial (#1. Detection of TADs) using the optimal parameters from the second tutorial (#2 Parameter optimization.</p>
<p>All models are based on specific sets of experimental data for which TADbit modeling parameters need to be optimized (see tutorial #2). Optimizing the parameters takes significant CPU time and thus have created a python dictionary with sets of pre-optimized parameters for relaeased datasets. The specific parameters are stored in a python dictionary called CONFIG.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># See pre-defined sets of parameters</span>
<span class="n">CONFIG</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
{'dmel_01': {'kforce': 5,
  'lowfreq': -0.7,
  'maxdist': 600,
  'reference': 'victor corces dataset 2013',
  'scale': 0.01,
  'upfreq': 0.3}}
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Overtime, we will populate the CONFIG dictionary with more optimal sets of parameters for released Hi-C matrices.</p>
</div>
<p>To set the values for the parameters, one can create an array and use it for moodeling (see config parameter for model_region function)</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Set of optimal parameters from pervious tutorial #2</span>
<span class="n">optpar</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;kforce&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
          <span class="s">&#39;lowfreq&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span>
          <span class="s">&#39;lowrdist&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
          <span class="s">&#39;upfreq&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
          <span class="s">&#39;maxdist&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>
          <span class="s">&#39;scale&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
          <span class="s">&#39;reference&#39;</span><span class="p">:</span> <span class="s">&#39;Dekker dataset optimzed for TAD24&#39;</span><span class="p">}</span>

<span class="c"># Build 3D models based on the HiC data. This is done by IMP.</span>
<span class="n">models</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">model_region</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">n_models</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">n_keep</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_cpus</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">keep_all</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">optpar</span><span class="p">)</span>
<span class="k">print</span> <span class="n">models</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
/usr/local/lib/python2.7/dist-packages/pytadbit/experiment.py:609: UserWarning: WARNING: normalizing according to visibility method
  warn('WARNING: normalizing according to visibility method')
</pre>
<pre class="ansi-block literal-block">
StructuralModels with 100 models of 101 particles
   (objective function range: 81602927 - 83896811)
   (corresponding to the best models out of 500 models).
  IMP modeling used this parameters:
   - maxdist     : 2000
   - upfreq      : 0.8
   - reference   : Dekker dataset optimzed for TAD24
   - kforce      : 5
   - lowfreq     : -0.2
   - scale       : 0.01
   - lowrdist    : 1000.0
  Models where clustered into 0 clusters
</pre>
<p>Once finished, the IMP generated models are stored in a dictionary which keys are numbered from smaller to larger based on the IMP Objective Function (that is, how well the model satifies the input restraints). One can select parts of the models or single models to get some information.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Select top 10 models</span>
<span class="n">models</span><span class="o">.</span><span class="n">define_best_models</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;Lowest 10 IMP OF models:&quot;</span>
<span class="k">print</span> <span class="n">models</span>

<span class="c"># Select top 100 models</span>
<span class="n">models</span><span class="o">.</span><span class="n">define_best_models</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;Lowest 100 IMP OF models:&quot;</span>
<span class="k">print</span> <span class="n">models</span>

<span class="c"># Get the data for the lowest IMP OF model (number 0) in the set of models</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span> <span class="n">model</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
Lowest 10 IMP OF models:
StructuralModels with 10 models of 101 particles
   (objective function range: 81602927 - 82071585)
   (corresponding to the best models out of 500 models).
  IMP modeling used this parameters:
   - maxdist     : 2000
   - upfreq      : 0.8
   - reference   : Dekker dataset optimzed for TAD24
   - kforce      : 5
   - lowfreq     : -0.2
   - scale       : 0.01
   - lowrdist    : 1000.0
  Models where clustered into 0 clusters
Lowest 100 IMP OF models:
StructuralModels with 100 models of 101 particles
   (objective function range: 81602927 - 83896811)
   (corresponding to the best models out of 500 models).
  IMP modeling used this parameters:
   - maxdist     : 2000
   - upfreq      : 0.8
   - reference   : Dekker dataset optimzed for TAD24
   - kforce      : 5
   - lowfreq     : -0.2
   - scale       : 0.01
   - lowrdist    : 1000.0
  Models where clustered into 0 clusters
IMP model ranked 1 (101 particles) with:
 - Final objective function value: 81602927.3771
 - random initial value: 468
 - first coordinates:
        X      Y      Z
     4012   2578   1748
     4624   2999   2401
     4453   2049   2331
</pre>
<p>One measure to check whether the IMP optimization has reached equilibrium is to plot the value of the IMP Objective Function as a function of the iteration during optimization. If the plot has a plateau, this means that the modeling exercise run properly.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Get the IMP OF of the stored model in &quot;model&quot;</span>
<span class="n">model</span><span class="o">.</span><span class="n">objective_function</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/tutorial_6_modelling_and_analysis_15_0.png" src="../_images/tutorial_6_modelling_and_analysis_15_0.png" />
<p>One important aspect is to identfy whether the set of models has a good correlation with the input HiC data. This can be done with a single function that affects the models.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Re-select again the top 1000 models</span>
<span class="n">models</span><span class="o">.</span><span class="n">define_best_models</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="c"># Calculate the correlation coefficient between a set of kept models and the original HiC matrix</span>
<span class="n">models</span><span class="o">.</span><span class="n">correlate_with_real_data</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/tutorial_6_modelling_and_analysis_17_0.png" src="../_images/tutorial_6_modelling_and_analysis_17_0.png" />
<pre class="ansi-block literal-block">
(0.75025435625955283, 0.0)
</pre>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">models</span><span class="o">.</span><span class="n">zscore_plot</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/tutorial_6_modelling_and_analysis_18_0.png" src="../_images/tutorial_6_modelling_and_analysis_18_0.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">models</span><span class="o">.</span><span class="n">align_models</span><span class="p">(</span><span class="n">in_place</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">models</span><span class="o">.</span><span class="n">deconvolve</span><span class="p">(</span><span class="n">fact</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">dcutoff</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">represent_models</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">n_best_clusters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
Total number of clusters: 13
   Cluster #1 has 6 models [top model: 113]
   Cluster #2 has 4 models [top model: 142]
   Cluster #3 has 3 models [top model: 277]
   Cluster #4 has 3 models [top model: 199]
   Cluster #5 has 3 models [top model: 354]
   Cluster #6 has 3 models [top model: 362]
   Cluster #7 has 3 models [top model: 174]
   Cluster #8 has 2 models [top model: 471]
   Cluster #9 has 2 models [top model: 349]
   Cluster #10 has 2 models [top model: 243]
   Cluster #11 has 2 models [top model: 88]
   Cluster #12 has 2 models [top model: 413]
   Cluster #13 has 2 models [top model: 241]
</pre>
<img alt="../_images/tutorial_6_modelling_and_analysis_19_1.png" src="../_images/tutorial_6_modelling_and_analysis_19_1.png" />
</div>
<div class="section" id="model-analysis">
<h2>Model analysis<a class="headerlink" href="#model-analysis" title="Permalink to this headline">¶</a></h2>
<div class="section" id="model-clustering">
<h3>Model clustering<a class="headerlink" href="#model-clustering" title="Permalink to this headline">¶</a></h3>
<p>First we are going to cluster the 3D models based on their structural similarity. Clusters are numbered from larger (more models) to smallest (less models).</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Cluster models based on structural similarity</span>
<span class="n">models</span><span class="o">.</span><span class="n">cluster_models</span><span class="p">(</span><span class="n">fact</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">dcutoff</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="k">print</span> <span class="n">models</span><span class="o">.</span><span class="n">clusters</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
Number of singletons excluded from clustering: 98 (total singletons: 98)
Total number of clusters: 1
   Cluster #1 has 2 models [top model: 230]

Total number of clusters: 1
   Cluster #1 has 2 models [top model: 230]
</pre>
<p>The output of this analysis is stored in a Python dictionary that contains the cluster number and the models within the cluster. The output shows that the models result in 39 clusters where cluster number 1 (named 0) contains 149 models and cluster number 2 (named 1) contains 136 models.</p>
<p>Once a cluster is generated, one can plot it for easy visualization. The &#8220;y&#8221; axis of the plot shows the IMP Objective function. The width of the branch is proportional to the number of models in the cluster. One would expect that the largest cluster (the one numbered with a &#8220;0&#8221; and wider width branch) has the lowest IMP Objective Function. This is indicative that the optimization found most often the same solution, which corresponded to the lowest IMP Objective Function.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Plot the resulting clusers</span>
<span class="n">cl</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">cluster_analysis_dendrogram</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
/usr/local/lib/python2.7/dist-packages/pytadbit/imp/structuralmodels.py:472: UserWarning: Need at least 2 clusters to display...
  warn(&quot;Need at least 2 clusters to display...&quot;)
</pre>
<p>One can also show the similarity betwen clusters for a limited number of them (5 in this example)</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Show de dendogram for only the 5 top clusters and no colors</span>
<span class="n">cl</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">cluster_analysis_dendrogram</span><span class="p">(</span><span class="n">n_best_clusters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><pre>---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)

&lt;ipython-input-12-3f4a2de88345&gt; in &lt;module&gt;()
      1 # Show de dendogram for only the 5 top clusters and no colors
----&gt; 2 cl = models.cluster_analysis_dendrogram(n_best_clusters=5)


/usr/local/lib/python2.7/dist-packages/pytadbit/imp/structuralmodels.pyc in cluster_analysis_dendrogram(self, n_best_clusters, color, axe, savefig, **kwargs)
    477         maxnrj = max(objfun.values()) - 1
    478         val = (maxnrj-minnrj)
--&gt; 479         maxz = max([i[2] for i in z])
    480         for i in z:
    481             i[2] = i[2]/maxz * val


ValueError: max() arg is an empty sequence</pre>
</div>
</div>
<div class="section" id="models-consistency">
<h3>Models consistency<a class="headerlink" href="#models-consistency" title="Permalink to this headline">¶</a></h3>
<p>To assess how &#8220;deterministic&#8221; a cluster is, one can calculate for each particle the percentage of models (in the cluster) that superimpose a given particle within a given cut-off (pre-set cut-offs of 50, 100, 150 and 200 nm). The lower the consistency value (in %) the less deterministic the models within the selected cluster. This measure can be taken as a proxy of variability across the model.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Calculate the consistency plot for all models in the first cluster (cluster 0)</span>
<span class="n">models</span><span class="o">.</span><span class="n">model_consistency</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cutoffs</span><span class="o">=</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="mi">1200</span><span class="p">))</span>
</pre></div>
</div>
<p>Be aware that this measure makes sense using only models within a cluster and not models from different clusters.</p>
</div>
<div class="section" id="dna-density-plots">
<h3>DNA density plots<a class="headerlink" href="#dna-density-plots" title="Permalink to this headline">¶</a></h3>
<p>From the 3D models, the DNA density (or local compactness) can be calculated as the ratio of the bin size (in base pairs) and the distances between consequtive particles in the models. The higher the density the more compact DNA for the region. As this measure varies dramatically from particle to particle, one can calculate it using running averages.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Calculate a DNA density plot</span>
<span class="n">models</span><span class="o">.</span><span class="n">density_plot</span><span class="p">()</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Get a similar plot for only the top cluster and show the standar deviation for a specific(s) running window (steps)</span>
<span class="n">models</span><span class="o">.</span><span class="n">density_plot</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">error</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">models</span><span class="o">.</span><span class="n">walking_angle</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">signed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">models</span><span class="o">.</span><span class="n">interactions</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="models-contact-map">
<h3>Models contact map<a class="headerlink" href="#models-contact-map" title="Permalink to this headline">¶</a></h3>
<p>Given a set of selected models (either from a cluster or a list) one can calculate the percentage of pairs of particles within a distance cut-off. This can then be represented as a heat-map which is equivalent to a Hi-C interaction matrix.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Get a contact map for the top 50 models at a distance cut-off of 300nm</span>
<span class="n">models</span><span class="o">.</span><span class="n">contact_map</span><span class="p">(</span><span class="n">models</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">savedata</span><span class="o">=</span><span class="s">&quot;contact.txt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The goal of TADbit is to find a 3D structure (or ensemble of structures) that best satisfies the original Hi-C matrix. Therefore, we can compare the contact map produced above to the original HiC input matrix for parts of the models.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Correlate the contact map with the original input HiC matrix for cluster 0</span>
<span class="n">models</span><span class="o">.</span><span class="n">correlate_with_real_data</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span>
<span class="c"># Correlate the contact map with the original input HiC matrix for cluster 1</span>
<span class="n">models</span><span class="o">.</span><span class="n">correlate_with_real_data</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span>
<span class="c"># Correlate the contact map with the original input HiC matrix for cluster 10</span>
<span class="n">models</span><span class="o">.</span><span class="n">correlate_with_real_data</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="calculating-distances-between-particles">
<h3>Calculating distances between particles<a class="headerlink" href="#calculating-distances-between-particles" title="Permalink to this headline">¶</a></h3>
<p>Sometimes is useful to get a distribution of distances between pairs of particles in the models (or sub-set of models). Next we show several ways of getting such representations.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Get the average distance between particles 13 and 30 in all kept models</span>
<span class="n">models</span><span class="o">.</span><span class="n">median_3d_dist</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Lets plot the distribution used to get this median value.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Plot the distance distributions between particles 13 and 30 in all kept models</span>
<span class="n">models</span><span class="o">.</span><span class="n">median_3d_dist</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>We may also want to use only the 10 first models (lowest energy), or the models belonging to a cluster (example cluster 1).</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Plot the distance distributions between particles 13 and 30 in the top 100 models</span>
<span class="n">models</span><span class="o">.</span><span class="n">median_3d_dist</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Plot the distance distributions between particles 13 and 30 in the models from cluster 0</span>
<span class="n">models</span><span class="o">.</span><span class="n">median_3d_dist</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cluster</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="save-and-load-models-and-analysis">
<h2>Save and load models and analysis<a class="headerlink" href="#save-and-load-models-and-analysis" title="Permalink to this headline">¶</a></h2>
<p>By saving your analysis, you won&#8217;t need to repeat some of the most expensive calculations.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Save your entire analysis and models</span>
<span class="n">models</span><span class="o">.</span><span class="n">save_models</span><span class="p">(</span><span class="s">&#39;gm_01.models&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>And to load them:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Load the models</span>
<span class="n">models</span> <span class="o">=</span> <span class="n">load_structuralmodels</span><span class="p">(</span><span class="s">&#39;gm_01.models&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">models</span>
</pre></div>
</div>
<dl class="docutils">
<dt>Specific 3D models can be saved in two formats:</dt>
<dd><ul class="first last simple">
<li>CMM format, which can be directly load into Chimera for visualization.</li>
<li>XYZ format, which is a simple format that can be useful for further analysis that require coordinates.</li>
</ul>
</dd>
</dl>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Write a CMM file for the top model</span>
<span class="n">models</span><span class="o">.</span><span class="n">write_cmm</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s">&quot;./&quot;</span><span class="p">,</span> <span class="n">model_num</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c"># Write a XYZ file for the top model</span>
<span class="n">models</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s">&quot;./&quot;</span><span class="p">,</span> <span class="n">model_num</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c"># Write a XYZ file for the top 10 models</span>
<span class="n">models</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s">&quot;./&quot;</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="c"># Write a XYZ file for the cluster 1 models</span>
<span class="n">models</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s">&quot;./&quot;</span><span class="p">,</span> <span class="n">cluster</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="related-software">
<h2>Related Software<a class="headerlink" href="#related-software" title="Permalink to this headline">¶</a></h2>
<div class="section" id="chimera">
<h3>Chimera<a class="headerlink" href="#chimera" title="Permalink to this headline">¶</a></h3>
<p>Our group has been using the visualization tool Chimera from Ferrin&#8217;s Group at UCSF (<a class="reference external" href="http://www.cgl.ucsf.edu/chimera/">http://www.cgl.ucsf.edu/chimera/</a>) to visualize the 3D models. Here we provide a couple of automatic ways of getting static and video images of selected models. A user can input the models using the generated CMM format in the previous step of this tutorial.</p>
<p>** NOTE **
To properly insert the images/videos in this tutorial, we need to import libraries from IPython. However, such libraries are not necessary for the modeling nor the analysis of the models.
** NOTE **</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">models</span><span class="o">.</span><span class="n">view_models</span><span class="p">(</span><span class="n">stress</span><span class="o">=</span><span class="s">&#39;centroid&#39;</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="s">&#39;plot&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">azimuth</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">gyradius</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Generate the image using Chimera in batch mode. That takes some time, wait a bit before running next command.</span>
<span class="c"># You can check in your home directory whether this has finished.</span>
<span class="n">models</span><span class="o">.</span><span class="n">view_models</span><span class="p">(</span><span class="n">models</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tool</span><span class="o">=</span><span class="s">&#39;chimera_nogui&#39;</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="s">&#39;/tmp/image_model_1.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Generate the video using Chimera in batch mode. That takes SIGNIFICANT time, wait a bit before running next command.</span>
<span class="c"># You can check in your home directory whether this has finished.</span>
<span class="n">models</span><span class="o">.</span><span class="n">view_models</span><span class="p">(</span><span class="n">models</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tool</span><span class="o">=</span><span class="s">&#39;chimera_nogui&#39;</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="s">&#39;/tmp/image_model_1.webm&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/TADbit_logo_little.png" alt="Logo"/>
            </a></p>
<h3><a href="../index.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installing TADbit on GNU/Linux</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../tutorial.html#identification-and-analysis-of-tads">Identification and Analysis of TADs</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../tutorial.html#three-dimentional-modelling">Three-dimentional modelling</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="tutorial_4_data_normalization.html">Hi-C data processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_5_parameter_optimization.html">Parameter optimization for IMP.</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="">Three-dimensional modeling of chromatine structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_7_single_model_analysis.html">Structural analysis of a chromatin model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../biblio.html">Bibliography</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="tutorial_5_parameter_optimization.html"
                        title="previous chapter">Parameter optimization for IMP.</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="tutorial_7_single_model_analysis.html"
                        title="next chapter">Structural analysis of a chromatin model</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="tutorial_7_single_model_analysis.html" title="Structural analysis of a chromatin model"
             >next</a> |</li>
        <li class="right" >
          <a href="tutorial_5_parameter_optimization.html" title="Parameter optimization for IMP."
             >previous</a> |</li>
        <li><a href="../index.html">Tadbit 0.1 documentation</a> &raquo;</li>
          <li><a href="../tutorial.html" >Tutorials</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright .
      Last updated on May 16, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div><style>div.related ul {padding-right:150px;}</style>
        <a href="https://github.com/3DGenomes/tadbit" target="_blank"><img
            style="position: absolute; top: 0; right: 0; border: 0;"
            src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
  </body>
</html>