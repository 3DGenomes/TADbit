<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Parameter optimization for IMP. &mdash; Tadbit 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/forkme_nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/black-on-white.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../_static/TADbit_icon.ico"/>
    <link rel="top" title="Tadbit 0.1 documentation" href="../index.html" />
    <link rel="up" title="Tutorials" href="../tutorial.html" />
    <link rel="next" title="Three-dimensional modeling of chromatine structure" href="tutorial_6_modelling_and_analysis.html" />
    <link rel="prev" title="Hi-C data processing" href="tutorial_4_data_normalization.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="tutorial_6_modelling_and_analysis.html" title="Three-dimensional modeling of chromatine structure"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="tutorial_4_data_normalization.html" title="Hi-C data processing"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Tadbit 0.1 documentation</a> &raquo;</li>
          <li><a href="../tutorial.html" accesskey="U">Tutorials</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="parameter-optimization-for-imp">
<h1>Parameter optimization for IMP.<a class="headerlink" href="#parameter-optimization-for-imp" title="Permalink to this headline">¶</a></h1>
<p><em>Recover data from previous section by loading the previously saved chromosome and its Hi-C data.</em></p>
<p>Import the necessary libraries.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Libraries</span>
<span class="kn">from</span> <span class="nn">pytadbit</span> <span class="kn">import</span> <span class="n">load_chromosome</span> <span class="c"># to load chromosomes</span>
<span class="kn">from</span> <span class="nn">pytadbit.imp.impoptimizer</span> <span class="kn">import</span> <span class="n">IMPoptimizer</span>
</pre></div>
</div>
<p>First, load the chromosome from previous tutorial (<a class="reference internal" href="tutorial_1_general.html#run-tadbit"><em>Find Topologically Associating Domains</em></a>).</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Load the chromosome</span>
<span class="n">my_chrom</span> <span class="o">=</span> <span class="n">load_chromosome</span><span class="p">(</span><span class="s">&#39;some_path.tdb&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, load Hi-C data for each experiment (Hi-C data is not saved inside chromosome objects because of their size):</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Loop over experiments in chromosome and load Hi-C data.</span>
<span class="n">res</span> <span class="o">=</span> <span class="mi">100000</span>

<span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">exp</span><span class="o">.</span><span class="n">load_hic_data</span><span class="p">(</span><span class="s">&#39;../../scripts/sample_data/HIC_{0}_{1}_{1}_{2}_obs.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                          <span class="n">exp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">my_chrom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;file not found for experiment: &#39;</span> <span class="o">+</span> <span class="n">exp</span><span class="o">.</span><span class="n">name</span>
        <span class="k">continue</span>
    <span class="k">print</span> <span class="n">exp</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
/usr/local/lib/python2.7/dist-packages/pytadbit/parsers/hic_parser.py:93: UserWarning: WARNING: non integer values
  warn('WARNING: non integer values')

WARNING: removing columns having less than 24.165 counts: (detected threshold)
    8    9   10   12  245  246  247  248  249  250  251  252  253  254  255
  256  257  258  259  260  261  262  263  264  265  266  267  268  269  270
  271  272  273  274  275  276  277  278  279  280  281  282  283  284  285
  286  287  288  289  290  291  292  293  294  295  296  297  298  299  300
  301  302  303  304  305  306  307  308  309  310  311  312  313  314  315
  316  317  318  319  320  321  322  323  324  639
</pre>
<pre class="ansi-block literal-block">
Experiment k562:
   resolution        : 100Kb
   TADs              : 37
   Hi-C rows         : 639
   normalized        : None
   identifier        : k562
   cell type         : wild type
   restriction enzyme: UNKNOWN
   project           : TADbit tutorial

Experiment gm06690:
   resolution        : 100Kb
   TADs              : 34
   Hi-C rows         : 639
   normalized        : None
   identifier        : gm06690
   cell type         : cancer
   restriction enzyme: UNKNOWN
   project           : TADbit tutorial

file not found for experiment: k562+gm06690
file not found for experiment: batch_gm06690_k562
</pre>
<pre class="ansi-block literal-block">
/usr/local/lib/python2.7/dist-packages/pytadbit/utils/hic_filtering.py:209: ComplexWarning: Casting complex values to real discards the imaginary part
  round(root, 3), ' '.join(

WARNING: removing columns having less than 67.485 counts: (detected threshold)
  246  247  248  249  250  251  252  253  254  255  256  257  258  259  260
  261  262  263  264  265  266  267  268  269  270  271  272  273  274  275
  276  277  278  279  280  281  282  283  284  285  286  287  288  289  290
  291  292  293  294  295  296  297  298  299  300  301  302  303  304  305
  306  307  308  309  310  311  312  313  314  315  316  317  318  319  320
  321  322  323  324  639
</pre>
<p>The log indicates that experiment &#8220;k562+gm06690&#8221; had no file. Such experiment was built ad-hoc in our previous tutorial and needs to be created again by summing the Hi-C matrices from the individual experiments.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Load Hi-C of the individual experiments and put it into the sum experiment BR+TR1+TR2</span>
<span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="s">&#39;k562+gm06690&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load_hic_data</span><span class="p">(</span>
              <span class="p">(</span><span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="s">&#39;k562&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="s">&#39;gm06690&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">hic_data</span><span class="p">,</span>
              <span class="s">&#39;k562+gm06690&#39;</span><span class="p">)</span>
<span class="n">exp</span> <span class="o">=</span> <span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="s">&#39;gm06690&#39;</span><span class="p">]</span>

<span class="k">print</span> <span class="n">my_chrom</span><span class="o">.</span><span class="n">experiments</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
WARNING: removing columns having less than 73.545 counts: (detected threshold)
  246  247  248  249  250  251  252  253  254  255  256  257  258  259  260
  261  262  263  264  265  266  267  268  269  270  271  272  273  274  275
  276  277  278  279  280  281  282  283  284  285  286  287  288  289  290
  291  292  293  294  295  296  297  298  299  300  301  302  303  304  305
  306  307  308  309  310  311  312  313  314  315  316  317  318  319  320
  321  322  323  324  639
/usr/local/lib/python2.7/dist-packages/pytadbit/experiment.py:202: UserWarning: WARNING: experiments should be normalized before being summed

  'summed\n')

WARNING: removing columns having less than 73.545 counts: (detected threshold)
  246  247  248  249  250  251  252  253  254  255  256  257  258  259  260
  261  262  263  264  265  266  267  268  269  270  271  272  273  274  275
  276  277  278  279  280  281  282  283  284  285  286  287  288  289  290
  291  292  293  294  295  296  297  298  299  300  301  302  303  304  305
  306  307  308  309  310  311  312  313  314  315  316  317  318  319  320
  321  322  323  324  639
</pre>
<pre class="ansi-block literal-block">
[Experiment k562 (resolution: 100Kb, TADs: 37, Hi-C rows: 639, normalized: None), Experiment gm06690 (resolution: 100Kb, TADs: 34, Hi-C rows: 639, normalized: None), Experiment k562+gm06690 (resolution: 100Kb, TADs: None, Hi-C rows: 639, normalized: None), Experiment batch_gm06690_k562 (resolution: 100Kb, TADs: 35, Hi-C rows: 639, normalized: None)]
</pre>
<div class="section" id="optimization-of-imp-3d-modeling-parameters">
<h2>Optimization of IMP 3D modeling parameters<a class="headerlink" href="#optimization-of-imp-3d-modeling-parameters" title="Permalink to this headline">¶</a></h2>
<p>In the previous tutorial we found a specific TAD (region 406 to 448) that seemed quite conserved accross different cell types.</p>
<p>Next, we will optimize the three IMP parameters for this TAD. The IMP parameters to optimize are maximal distance between two non-interacting particles (maxdist), Upper-bound Z-score (upfreq) and Lower-bound Z-score (lowfreq). For details see Bau &amp; Marti-Renom. METHODS <a class="reference internal" href="../biblio.html#bau2012" id="id1">[Baù2012]</a>.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">optimizer</span> <span class="o">=</span> <span class="n">IMPoptimizer</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">n_models</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">n_keep</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
/usr/local/lib/python2.7/dist-packages/pytadbit/experiment.py:700: UserWarning: WARNING: normalizing according to visibility method
  warn('WARNING: normalizing according to visibility method')
</pre>
<p><tt class="docutils literal"><span class="pre">cutoff</span></tt> value corresponds to the distance limit, in nanometers, to consider if two particles of a model are interacting or not. A wise choice corresponds to two time the resolution times the scale factor (0.01), which in this case is <span class="math">\(cutoff = 100Kb \times 2 \times scale = 100000 \times 2 \times 0.01 = 2000\)</span></p>
<p><em>Note: Usually the number of models to generate and to keep, should be respectively 500 and 100.</em></p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Optimize parameters. Be aware that this step is CPU intensive. If you want to se the progress, set verbose=True.</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">run_grid_search</span><span class="p">(</span><span class="n">n_cpus</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">lowfreq_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">upfreq_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
                          <span class="n">maxdist_range</span><span class="o">=</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
  1  0.2 -1 2000 0.01 0.7685079084
  2  0.2 -0.8 2000 0.01 0.7685079084
  3  0.2 -0.6 2000 0.01 0.769312534002
  4  0.2 -0.4 2000 0.01 0.774552988272
  5  0.2 -0.2 2000 0.01 0.774799693632
  6  0.2 0 2000 0.01 0.779079372102
  7  0.4 -1 2000 0.01 0.77968485295
  8  0.4 -0.8 2000 0.01 0.77968485295
  9  0.4 -0.6 2000 0.01 0.777330669016
 10  0.4 -0.4 2000 0.01 0.781161643149
 11  0.4 -0.2 2000 0.01 0.784325067495
 12  0.4 0 2000 0.01 0.786674923707
 13  0.6 -1 2000 0.01 0.784429455755
 14  0.6 -0.8 2000 0.01 0.784429455755
 15  0.6 -0.6 2000 0.01 0.785634447252
 16  0.6 -0.4 2000 0.01 0.786321444973
 17  0.6 -0.2 2000 0.01 0.786910943468
 18  0.6 0 2000 0.01 0.786984401856
 19  0.8 -1 2000 0.01 0.790513719434
 20  0.8 -0.8 2000 0.01 0.790513719434
 21  0.8 -0.6 2000 0.01 0.790296856543
 22  0.8 -0.4 2000 0.01 0.793885340581
 23  0.8 -0.2 2000 0.01 0.789759250026
 24  0.8 0 2000 0.01 0.789797737342
 25  0.2 -1 2500 0.01 0.750962048643
 26  0.2 -0.8 2500 0.01 0.750962048643
 27  0.2 -0.6 2500 0.01 0.757205157705
 28  0.2 -0.4 2500 0.01 0.761306112068
 29  0.2 -0.2 2500 0.01 0.774749585795
 30  0.2 0 2500 0.01 0.77526716922
 31  0.4 -1 2500 0.01 0.768413156879
 32  0.4 -0.8 2500 0.01 0.768413156879
 33  0.4 -0.6 2500 0.01 0.769621944212
 34  0.4 -0.4 2500 0.01 0.774313586043
 35  0.4 -0.2 2500 0.01 0.784154703349
 36  0.4 0 2500 0.01 0.780215999106
 37  0.6 -1 2500 0.01 0.7769226588
 38  0.6 -0.8 2500 0.01 0.7769226588
 39  0.6 -0.6 2500 0.01 0.7771795099
 40  0.6 -0.4 2500 0.01 0.781692802602
 41  0.6 -0.2 2500 0.01 0.791132811629
 42  0.6 0 2500 0.01 0.791622500864
 43  0.8 -1 2500 0.01 0.794414661228
 44  0.8 -0.8 2500 0.01 0.794414661228
 45  0.8 -0.6 2500 0.01 0.791675414244
 46  0.8 -0.4 2500 0.01 0.797601045479
 47  0.8 -0.2 2500 0.01 0.797521713992
 48  0.8 0 2500 0.01 0.797093368434
 49  0.2 -1 3000 0.01 0.747088558176
 50  0.2 -0.8 3000 0.01 0.747088558176
 51  0.2 -0.6 3000 0.01 0.745301762181
 52  0.2 -0.4 3000 0.01 0.75657287698
 53  0.2 -0.2 3000 0.01 0.768255433103
 54  0.2 0 3000 0.01 0.771134956344
 55  0.4 -1 3000 0.01 0.760224850725
 56  0.4 -0.8 3000 0.01 0.760224850725
 57  0.4 -0.6 3000 0.01 0.758212146329
 58  0.4 -0.4 3000 0.01 0.76576862456
 59  0.4 -0.2 3000 0.01 0.778685124478
 60  0.4 0 3000 0.01 0.779102317515
 61  0.6 -1 3000 0.01 0.77089869622
 62  0.6 -0.8 3000 0.01 0.77089869622
 63  0.6 -0.6 3000 0.01 0.771149348295
 64  0.6 -0.4 3000 0.01 0.778054314513
 65  0.6 -0.2 3000 0.01 0.788888301661
 66  0.6 0 3000 0.01 0.792927420622
 67  0.8 -1 3000 0.01 0.787058090092
 68  0.8 -0.8 3000 0.01 0.787058090092
 69  0.8 -0.6 3000 0.01 0.787064682158
 70  0.8 -0.4 3000 0.01 0.789444985636
 71  0.8 -0.2 3000 0.01 0.795363982681
 72  0.8 0 3000 0.01 0.798344059632
 73  0.2 -1 3500 0.01 0.742503135603
 74  0.2 -0.8 3500 0.01 0.742503135603
 75  0.2 -0.6 3500 0.01 0.745313876975
 76  0.2 -0.4 3500 0.01 0.757818572633
 77  0.2 -0.2 3500 0.01 0.768088409932
 78  0.2 0 3500 0.01 0.772953014174
 79  0.4 -1 3500 0.01 0.758090294693
 80  0.4 -0.8 3500 0.01 0.758090294693
 81  0.4 -0.6 3500 0.01 0.756077064231
 82  0.4 -0.4 3500 0.01 0.760791799894
 83  0.4 -0.2 3500 0.01 0.770118662441
 84  0.4 0 3500 0.01 0.771190886989
 85  0.6 -1 3500 0.01 0.755069982191
 86  0.6 -0.8 3500 0.01 0.755069982191
 87  0.6 -0.6 3500 0.01 0.753952944201
 88  0.6 -0.4 3500 0.01 0.760897343161
 89  0.6 -0.2 3500 0.01 0.771145005701
 90  0.6 0 3500 0.01 0.773442327166
 91  0.8 -1 3500 0.01 0.772281982099
 92  0.8 -0.8 3500 0.01 0.772281982099
 93  0.8 -0.6 3500 0.01 0.774513250696
 94  0.8 -0.4 3500 0.01 0.776897099364
 95  0.8 -0.2 3500 0.01 0.780965488029
 96  0.8 0 3500 0.01 0.778109941084
 97  0.2 -1 4000 0.01 0.74469288042
 98  0.2 -0.8 4000 0.01 0.74469288042
 99  0.2 -0.6 4000 0.01 0.744839537795
100  0.2 -0.4 4000 0.01 0.749552494453
101  0.2 -0.2 4000 0.01 0.756184508999
102  0.2 0 4000 0.01 0.759171645369
103  0.4 -1 4000 0.01 0.737113094756
104  0.4 -0.8 4000 0.01 0.737113094756
105  0.4 -0.6 4000 0.01 0.737373689722
106  0.4 -0.4 4000 0.01 0.739865712079
107  0.4 -0.2 4000 0.01 0.74968044876
108  0.4 0 4000 0.01 0.753525984586
109  0.6 -1 4000 0.01 0.740316370858
110  0.6 -0.8 4000 0.01 0.740316370858
111  0.6 -0.6 4000 0.01 0.739165113831
112  0.6 -0.4 4000 0.01 0.743513322704
113  0.6 -0.2 4000 0.01 0.7493620759
114  0.6 0 4000 0.01 0.751928906505
115  0.8 -1 4000 0.01 0.745707450814
116  0.8 -0.8 4000 0.01 0.745707450814
117  0.8 -0.6 4000 0.01 0.743929246866
118  0.8 -0.4 4000 0.01 0.746609953329
119  0.8 -0.2 4000 0.01 0.748258868417
120  0.8 0 4000 0.01 0.745006154143
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The above warning is given when a small matrix is loaded. TADbit has a filtering function that is applied to all Hi-C matrices with the aim of removing entire rows with very low counts. Those rows/colums are treated then for modeling as &#8220;missing-data&#8221; points. This flitering function can only be applied for relatively large matrices.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">By default TADbit does not store the models generated during the optimization, however, in case they are needed, the option savedata may allow to store them.</p>
</div>
<div class="section" id="optimizing-from-experiment">
<h3>Optimizing from Experiment<a class="headerlink" href="#optimizing-from-experiment" title="Permalink to this headline">¶</a></h3>
<p>The exact same as above can be done from Experiment objects directly:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">optimizer</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">optimal_imp_parameters</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">n_cpus</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_models</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">n_keep</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                                       <span class="n">lowfreq_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">upfreq_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
                                       <span class="n">maxdist_range</span><span class="o">=</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="visualize-the-results">
<h2>Visualize the results<a class="headerlink" href="#visualize-the-results" title="Permalink to this headline">¶</a></h2>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">optimizer</span><span class="o">.</span><span class="n">write_result</span><span class="p">(</span><span class="s">&#39;results.log&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Visualize the results of the optimization.</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">plot_2d</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/tutorial_5_parameter_optimization_21_0.png" src="../_images/tutorial_5_parameter_optimization_21_0.png" />
<p>We can also ask to mark on the plot the best N combination of parameters with the &#8220;show_best&#8221; parameter.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Visualize the results of the optimization and mark the best 10 parameter sets</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">plot_2d</span><span class="p">(</span><span class="n">show_best</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/tutorial_5_parameter_optimization_23_0.png" src="../_images/tutorial_5_parameter_optimization_23_0.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">axes_range</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">scale_range</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">maxdist_range</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">upfreq_range</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">lowfreq_range</span><span class="p">]]</span>

<span class="k">print</span> <span class="n">axes_range</span>
<span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes_range</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">_result_to_array</span><span class="p">()</span>
<span class="n">wax</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">zax</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">xax</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes_range</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
<span class="n">yax</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
<span class="n">sort_result</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">],</span> <span class="n">wax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">zax</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">xax</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">yax</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wax</span><span class="p">))</span>
                              <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zax</span><span class="p">))</span>
                              <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yax</span><span class="p">))</span>
                              <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xax</span><span class="p">))</span>
                              <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">])</span>
                              <span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span> <span class="n">sort_result</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
[[0.01], [2000.0, 2500.0, 3000.0, 3500.0, 4000.0], [0.2, 0.4, 0.6, 0.8], [-1.0, -0.8, -0.6, -0.4, -0.2, 0.0]]
(0.72369757668075985, 0.01, 2000.0, -0.2, 0.8)
</pre>
<p>One can also visualize the parameter optimization according to ne of the three optimization parameters.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Visualize the results of the optimization based on the lowfreq parameter.</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">plot_2d</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;upfreq&#39;</span><span class="p">,</span> <span class="s">&#39;lowfreq&#39;</span><span class="p">,</span> <span class="s">&#39;maxdist&#39;</span><span class="p">,</span> <span class="s">&#39;scale&#39;</span><span class="p">),</span><span class="n">show_best</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/tutorial_5_parameter_optimization_26_0.png" src="../_images/tutorial_5_parameter_optimization_26_0.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">optimizer</span><span class="o">.</span><span class="n">plot_2d</span><span class="p">(</span><span class="n">skip</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;scale&quot;</span><span class="p">:</span><span class="mf">0.01</span><span class="p">},</span> <span class="n">show_best</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/tutorial_5_parameter_optimization_27_0.png" src="../_images/tutorial_5_parameter_optimization_27_0.png" />
<p>TADbit also provides the possibility to view it all together in a 3D plot (note that, while here its a static image, inside matplotlib GUI you would be able to turn around and zoom):</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Visualize the results of the optimization using a 3D representation with the three optimization parameters in the axis.</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">plot_3d</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;scale&#39;</span><span class="p">,</span> <span class="s">&#39;maxdist&#39;</span><span class="p">,</span> <span class="s">&#39;upfreq&#39;</span><span class="p">,</span> <span class="s">&#39;lowfreq&#39;</span><span class="p">))</span>
</pre></div>
</div>
<img alt="../_images/tutorial_5_parameter_optimization_29_0.png" src="../_images/tutorial_5_parameter_optimization_29_0.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">optimizer</span><span class="o">.</span><span class="n">run_grid_search</span><span class="p">(</span><span class="n">n_cpus</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">lowfreq_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">upfreq_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
                          <span class="n">scale_range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">],</span> <span class="n">maxdist_range</span><span class="o">=</span><span class="p">[</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2250</span><span class="p">,</span><span class="mi">2500</span><span class="p">,</span><span class="mi">2750</span><span class="p">,</span><span class="mi">3000</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">optimizer</span><span class="o">.</span><span class="n">plot_2d</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/tutorial_5_parameter_optimization_31_0.png" src="../_images/tutorial_5_parameter_optimization_31_0.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">optimizer</span><span class="o">.</span><span class="n">plot_2d</span><span class="p">(</span><span class="n">show_best</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/tutorial_5_parameter_optimization_32_0.png" src="../_images/tutorial_5_parameter_optimization_32_0.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">optimizer</span><span class="o">.</span><span class="n">write_result</span><span class="p">(</span><span class="s">&#39;results.log&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">optimizer2</span> <span class="o">=</span> <span class="n">IMPoptimizer</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">n_models</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">n_keep</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">optimizer2</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="s">&#39;results.log&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">optimizer2</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">105</span><span class="p">]</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
('0.01', '2250', '0.4', '-0.8')
</pre>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">optimizer2</span><span class="o">.</span><span class="n">plot_2d</span><span class="p">(</span><span class="n">show_best</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/tutorial_5_parameter_optimization_37_0.png" src="../_images/tutorial_5_parameter_optimization_37_0.png" />
</div>
<div class="section" id="retrieve-best-parameters">
<h2>Retrieve best parameters<a class="headerlink" href="#retrieve-best-parameters" title="Permalink to this headline">¶</a></h2>
<p>Once done, best results can be returned as a dictionary to be used for modeling (see next section of the tutorial)</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">config</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">get_best_parameters_dict</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s">&#39;gm cell from Job Dekker 2009&#39;</span><span class="p">)</span>

<span class="k">print</span> <span class="n">config</span>
</pre></div>
</div>
<pre class="ansi-block literal-block">
{'maxdist': 2000.0, 'upfreq': 0.8, 'kforce': 5, 'reference': 'gm cell from Job Dekker 2009', 'lowfreq': -0.2, 'scale': 0.01}
</pre>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/TADbit_logo_little.png" alt="Logo"/>
            </a></p>
<h3><a href="../index.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installing TADbit on GNU/Linux</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../tutorial.html#identification-and-analysis-of-tads">Identification and Analysis of TADs</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../tutorial.html#three-dimentional-modelling">Three-dimentional modelling</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="tutorial_4_data_normalization.html">Hi-C data processing</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="">Parameter optimization for IMP.</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_6_modelling_and_analysis.html">Three-dimensional modeling of chromatine structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_7_single_model_analysis.html">Structural analysis of a chromatin model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../biblio.html">Bibliography</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="tutorial_4_data_normalization.html"
                        title="previous chapter">Hi-C data processing</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="tutorial_6_modelling_and_analysis.html"
                        title="next chapter">Three-dimensional modeling of chromatine structure</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="tutorial_6_modelling_and_analysis.html" title="Three-dimensional modeling of chromatine structure"
             >next</a> |</li>
        <li class="right" >
          <a href="tutorial_4_data_normalization.html" title="Hi-C data processing"
             >previous</a> |</li>
        <li><a href="../index.html">Tadbit 0.1 documentation</a> &raquo;</li>
          <li><a href="../tutorial.html" >Tutorials</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright .
      Last updated on May 15, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div><style>div.related ul {padding-right:150px;}</style>
        <a href="https://github.com/3DGenomes/tadbit" target="_blank"><img
            style="position: absolute; top: 0; right: 0; border: 0;"
            src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
  </body>
</html>